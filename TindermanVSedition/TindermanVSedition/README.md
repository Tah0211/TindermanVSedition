# TINDERMAN -VS EDITION-

Tinderman VS Edition は、C言語とSDL2で開発された対戦型戦略バトルゲームです。ネットワーク対戦に対応し、キャラクター育成要素とスキルベースの戦闘システムを特徴としています。

## 目次

- [特徴](#特徴)
- [システム要件](#システム要件)
- [インストール](#インストール)
- [ビルド方法](#ビルド方法)
- [実行方法](#実行方法)
- [ゲームモード](#ゲームモード)
- [操作方法](#操作方法)
- [プロジェクト構成](#プロジェクト構成)
- [トラブルシューティング](#トラブルシューティング)
- [技術情報](#技術情報)

## 特徴

- **ネットワーク対戦**: クライアント・サーバー方式による1対1のオンライン対戦
- **複数のキャラクター**: ひまり、きりたん、小夜などのキャラクターから選択可能
- **スキルベースの戦闘**: 多彩な技を駆使した戦略的バトルシステム
- **カットイン演出**: mpvによるフルスクリーン動画再生（2P側は左右反転対応）
- **育成要素**: キャラクターのステータス成長とスキル習得
- **チャットシステム**: 対戦相手とのコミュニケーション機能

## システム要件

### 必須環境

- **OS**: Linux（Ubuntuなど）、macOS
- **コンパイラ**: GCC (C11対応)
- **ライブラリ**:
  - SDL2 (開発版)
  - SDL2_image
  - SDL2_ttf
  - SDL2_mixer

### 推奨環境

- **動画再生**: mpv（カットイン演出用）
  - 同梱版の優先順位: \`./tools/mpv/mpv.AppImage\` → \`./tools/mpv/mpv\` → システムmpv

## インストール

### 依存ライブラリのインストール

#### Ubuntu/Debian

\`\`\`bash
sudo apt update
sudo apt install gcc make libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev libsdl2-mixer-dev
\`\`\`

#### macOS (Homebrew)

\`\`\`bash
brew install gcc make sdl2 sdl2_image sdl2_ttf sdl2_mixer
\`\`\`

### mpvのインストール（オプション）

カットイン演出を楽しむには、mpvが必要です。

#### Ubuntu/Debian

\`\`\`bash
sudo apt install mpv
\`\`\`

#### macOS

\`\`\`bash
brew install mpv
\`\`\`

## ビルド方法

### クライアント（ゲーム本体）のビルド

\`\`\`bash
make
\`\`\`

ビルドが成功すると、\`tvse\`という実行ファイルが生成されます。

### サーバーのビルド

\`\`\`bash
make server
\`\`\`

サーバー実行ファイル\`server/server\`が生成されます。

### クリーンビルド

\`\`\`bash
make clean
make
\`\`\`

## 実行方法

### 簡単起動（推奨）

対話的メニューで起動できるスクリプトを使用します：

\`\`\`bash
./run.sh
\`\`\`

起動時に以下を選択できます：
- **クライアント**: ゲームをプレイ
- **サーバー**: 対戦サーバーを起動

### 手動起動

#### サーバーの起動

\`\`\`bash
./server/server --port 5000
\`\`\`

オプション：
- \`--port <番号>\`: ポート番号を指定（デフォルト: 5000）

#### クライアントの起動

\`\`\`bash
./tvse --hostname localhost --port 5000
\`\`\`

オプション：
- \`-h, --hostname <ホスト>\`: 接続先サーバーのホスト名またはIPアドレス（デフォルト: localhost）
- \`-p, --port <番号>\`: 接続先ポート番号（デフォルト: 5000）

### ローカルプレイの例

1. ターミナル1でサーバーを起動：
\`\`\`bash
./server/server
\`\`\`

2. ターミナル2と3でクライアントを2つ起動：
\`\`\`bash
./tvse
./tvse
\`\`\`

## ゲームモード

### シーン一覧

1. **ホーム画面** (\`1_scene_home.c\`)
   - ゲームのメインメニュー

2. **キャラクター選択** (\`2_scene_select.c\`)
   - プレイキャラクターとパートナーの選択
   - 利用可能なキャラクター：ひまり、きりたん、小夜

3. **チャット** (\`3_scene_chat.c\`)
   - 対戦相手とのコミュニケーション
   - キャラクター名の表示

4. **育成/配分** (\`4_scene_allocate.c\`)
   - ステータスポイントの配分
   - スキルの習得

5. **バトル** (\`5_scene_battle.c\`)
   - ターン制の戦略的バトル
   - 移動、スキル、対象選択
   - カットイン演出

## 操作方法

### 基本操作

- **方向キー**: カーソル移動、選択
- **Enter/Space**: 決定
- **Escape**: キャンセル、メニューを戻る

### バトル中の操作

- **コマンド選択**: 移動、スキル使用などを選択
- **移動選択**: マス目を選択して移動
- **スキル選択**: 使用する技を選択
- **対象選択**: 攻撃対象やサポート対象を選択
- **範囲選択**: 範囲スキルの中心位置を選択

## プロジェクト構成

\`\`\`
TindermanVSedition/
├── main.c              # メインエントリーポイント
├── Makefile            # ビルド設定
├── run.sh              # 起動スクリプト
├── build.sh            # ビルドスクリプト
├── core/               # コアエンジン
│   ├── engine.c        # SDL初期化、メインループ
│   ├── scene_manager.c # シーン管理
│   └── input.c         # 入力処理
├── scenes/             # ゲームシーン
│   ├── 1_scene_home.c
│   ├── 2_scene_select.c
│   ├── 3_scene_chat.c
│   ├── 4_scene_allocate.c
│   └── 5_scene_battle.c
├── battle/             # バトルシステム
│   ├── battle_core.c   # バトルロジック
│   ├── battle_cmd.c    # コマンド処理
│   ├── battle_skills.c # スキル定義
│   ├── char_defs.c     # キャラクターステータス
│   └── cutin.c         # カットイン演出（mpv連携）
├── ui/                 # UIコンポーネント
│   ├── ui_button.c
│   ├── ui_card.c
│   └── ui_text.c
├── net/                # ネットワーク通信
│   └── net_client.c
├── util/               # ユーティリティ
│   ├── texture.c
│   ├── timer.c
│   └── json.c
├── server/             # 対戦サーバー
│   └── server.c
├── assets/             # ゲームアセット
│   ├── bg/             # 背景画像
│   ├── cutin/          # カットイン動画（MP4）
│   ├── effects/        # エフェクト
│   ├── font/           # フォント
│   ├── girls/          # キャラクター画像
│   ├── prompts/        # プロンプト
│   ├── ui/             # UI素材
│   └── voice/          # ボイス
└── tools/              # ツール
    └── mpv/            # 同梱mpv（オプション）
\`\`\`

## トラブルシューティング

### ビルドエラー

**問題**: \`SDL2/SDL.h: No such file or directory\`

**解決方法**: SDL2開発版がインストールされているか確認してください。

\`\`\`bash
# Ubuntu/Debian
sudo apt install libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev libsdl2-mixer-dev

# macOS
brew install sdl2 sdl2_image sdl2_ttf sdl2_mixer
\`\`\`

### カットインが再生されない

**問題**: スキル使用時のカットイン演出が表示されない

**原因と解決方法**:
1. **mpvが見つからない**: mpvをインストールするか、\`./tools/mpv/\`に配置してください
2. **動画ファイルが無い**: \`assets/cutin/\`に該当するMP4ファイルがあるか確認
3. **ゾンビプロセス**: 以前のmpvプロセスが残っている場合、プロセスを終了してください

### ネットワーク接続エラー

**問題**: サーバーに接続できない

**解決方法**:
1. サーバーが起動しているか確認
2. ファイアウォールでポート5000が開いているか確認
3. ホスト名とポート番号が正しいか確認

### 画面がフリーズする

**問題**: カットイン再生中にフリーズ

**解決方法**: 最新版では修正済みですが、古いバージョンの場合は以下を確認：
- mpvプロセスが正常に終了しているか確認
- EINTRエラーハンドリングが実装されているか（cutin.c 293-298行目）

## 技術情報

### アーキテクチャ

- **言語**: C11
- **グラフィックス**: SDL2
- **ネットワーク**: BSD Sockets
- **動画再生**: mpv（外部プロセス）
- **データ形式**: JSON（設定・ログ）

### パフォーマンス

- **フレームレート**: 可変（垂直同期）
- **イベント処理**: ノンブロッキング（SDL_PollEvent）
- **プロセス間通信**: fork/exec + waitpid

### セキュリティ

- EINTR安全な waitpid 実装
- ゾンビプロセスの自動回収
- ハードウェアデコード無効化（依存軽減）

### 最近の修正

#### アニメーション同時再生バグ修正（2026-02-05）

1P側と2P側が同じターンにスキルを使用した際、2番目のアニメーションが再生されない問題を修正しました。

**修正内容**:
- \`waitpid()\` の EINTR エラーハンドリング追加
- ゾンビプロセスクリーンアップ機能の実装
- 詳細は \`battle/cutin.c\` を参照

## 開発者向け情報

### コーディング規約

- C11標準準拠
- \`_POSIX_C_SOURCE=200809L\` 使用
- 関数プレフィックスでモジュール識別（例: \`battle_core_\`, \`scene_\`）

### デバッグログ

stderr にデバッグ情報が出力されます：

\`\`\`
[CUTIN] play: assets/cutin/skill1_char1.mp4 (fade=200, flip=0)
[CUTIN] spawn pid=12345
[CUTIN] mpv exited: status=0 exited=1 exitcode=0 signaled=0
\`\`\`

### カスタマイズ

- **新キャラクター追加**: \`battle/char_defs.c\` と \`assets/girls/\` に追加
- **新スキル追加**: \`battle/battle_skills.c\` で定義
- **新シーン追加**: \`scenes/\` に追加し \`scene_manager.c\` に登録

## ライセンス

このプロジェクトのライセンス情報については、リポジトリの管理者にお問い合わせください。

## 貢献

バグ報告や機能要望は、GitHubのIssuesでお願いします。

---

**Tinderman VS Edition** - 戦略とスキルで勝利を掴め！
